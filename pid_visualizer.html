<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PID Controller Visualizer - 29295C</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            text-align: center;
            margin-bottom: 30px;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .controls {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        
        .control-section {
            margin-bottom: 20px;
        }
        
        .control-section h3 {
            margin-bottom: 15px;
            color: #ffd700;
            border-bottom: 2px solid rgba(255,215,0,0.3);
            padding-bottom: 8px;
        }
        
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .control-item {
            display: flex;
            flex-direction: column;
        }
        
        .control-item label {
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .control-item input[type="number"],
        .control-item select {
            padding: 8px;
            border: none;
            border-radius: 5px;
            background: rgba(255,255,255,0.2);
            color: #fff;
            font-size: 1em;
        }
        
        .control-item input[type="number"]::placeholder {
            color: rgba(255,255,255,0.5);
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        button {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102,126,234,0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245,87,108,0.4);
        }
        
        .charts {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        
        .chart-container h3 {
            margin-bottom: 15px;
            color: #ffd700;
            text-align: center;
        }
        
        .stats {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        
        .stats h3 {
            margin-bottom: 15px;
            color: #ffd700;
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .stat-item {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #ffd700;
        }
        
        .stat-label {
            font-size: 0.85em;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.5em;
            font-weight: 700;
        }
        
        @media (max-width: 768px) {
            .charts {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ¤– PID Controller Visualizer</h1>
        <div class="subtitle">29295C Push-Back Robot - Real-time PID Response Simulation<br>
        <small style="font-size: 0.85em; opacity: 0.8;">Physics: 6:1 gearing (51 in/s), fast motor response, friction + aggressive coast braking</small></div>
        
        <div class="controls">
            <div class="control-section">
                <h3>Controller Type</h3>
                <div class="control-grid">
                    <div class="control-item">
                        <label for="controllerType">Select Controller:</label>
                        <select id="controllerType" onchange="updateControllerDefaults()">
                            <option value="drive">Drive PID</option>
                            <option value="turn">Turn PID</option>
                        </select>
                    </div>
                    <div class="control-item">
                        <label for="targetDistance">Target (inches/degrees):</label>
                        <input type="number" id="targetDistance" value="43" step="1">
                    </div>
                    <div class="control-item">
                        <label for="maxVelocity">Max Velocity (%):</label>
                        <input type="number" id="maxVelocity" value="100" min="0" max="100">
                    </div>
                </div>
            </div>
            
            <div class="control-section">
                <h3>PID Gains</h3>
                <div class="control-grid">
                    <div class="control-item">
                        <label for="kP">kP (Proportional):</label>
                        <input type="number" id="kP" value="6.0" step="0.1">
                    </div>
                    <div class="control-item">
                        <label for="kI">kI (Integral):</label>
                        <input type="number" id="kI" value="0.10" step="0.01">
                    </div>
                    <div class="control-item">
                        <label for="kD">kD (Derivative):</label>
                        <input type="number" id="kD" value="1.0" step="0.1">
                    </div>
                    <div class="control-item">
                        <label for="tolerance">Tolerance:</label>
                        <input type="number" id="tolerance" value="2.0" step="0.1">
                    </div>
                </div>
            </div>
            
            <div class="control-section">
                <h3>Advanced Parameters</h3>
                <div class="control-grid">
                    <div class="control-item">
                        <label for="slowZone">Slow Zone (decel region):</label>
                        <input type="number" id="slowZone" value="10.0" step="0.5">
                    </div>
                    <div class="control-item">
                        <label for="decelK">Decel Constant (k):</label>
                        <input type="number" id="decelK" value="0.10" step="0.01">
                    </div>
                    <div class="control-item">
                        <label for="maxDelta">Max Accel Rate (%/s):</label>
                        <input type="number" id="maxDelta" value="80.0" step="5">
                    </div>
                    <div class="control-item">
                        <label for="minSpeed">Min Speed (%):</label>
                        <input type="number" id="minSpeed" value="5.0" step="0.5">
                    </div>
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn-primary" onclick="runSimulation()">â–¶ Run Simulation</button>
                <button class="btn-secondary" onclick="resetSimulation()">ðŸ”„ Reset</button>
            </div>
        </div>
        
        <div class="charts">
            <div class="chart-container">
                <h3>Position & Error</h3>
                <canvas id="positionChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>PID Components</h3>
                <canvas id="pidChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Velocity Pipeline (% output)</h3>
                <canvas id="velocityChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Deceleration Profile</h3>
                <canvas id="decelChart"></canvas>
            </div>
        </div>
        
        <div class="stats">
            <h3>Performance Statistics</h3>
            <div class="stat-grid">
                <div class="stat-item">
                    <div class="stat-label">Settling Time</div>
                    <div class="stat-value" id="settlingTime">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Peak Velocity</div>
                    <div class="stat-value" id="peakVelocity">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Overshoot</div>
                    <div class="stat-value" id="overshoot">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Final Error</div>
                    <div class="stat-value" id="finalError">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Total Iterations</div>
                    <div class="stat-value" id="totalIterations">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Success</div>
                    <div class="stat-value" id="success">--</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Chart instances
        let positionChart, pidChart, velocityChart, decelChart;
        
        // Initialize charts
        function initCharts() {
            const chartConfig = {
                type: 'line',
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    animation: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            };
            
            positionChart = new Chart(document.getElementById('positionChart'), {
                ...chartConfig,
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Position', borderColor: '#4ade80', backgroundColor: 'rgba(74,222,128,0.1)', data: [], tension: 0.4 },
                        { label: 'Target', borderColor: '#fbbf24', backgroundColor: 'rgba(251,191,36,0.1)', data: [], borderDash: [5, 5] },
                        { label: 'Error', borderColor: '#f87171', backgroundColor: 'rgba(248,113,113,0.1)', data: [], tension: 0.4 }
                    ]
                }
            });
            
            pidChart = new Chart(document.getElementById('pidChart'), {
                ...chartConfig,
                data: {
                    labels: [],
                    datasets: [
                        { label: 'P Term', borderColor: '#60a5fa', backgroundColor: 'rgba(96,165,250,0.1)', data: [], tension: 0.4 },
                        { label: 'I Term', borderColor: '#a78bfa', backgroundColor: 'rgba(167,139,250,0.1)', data: [], tension: 0.4 },
                        { label: 'D Term', borderColor: '#f472b6', backgroundColor: 'rgba(244,114,182,0.1)', data: [], tension: 0.4 },
                        { label: 'Total PID', borderColor: '#fbbf24', backgroundColor: 'rgba(251,191,36,0.1)', data: [], tension: 0.4, borderWidth: 2 }
                    ]
                }
            });
            
            velocityChart = new Chart(document.getElementById('velocityChart'), {
                ...chartConfig,
                data: {
                    labels: [],
                    datasets: [
                        { label: 'PID Output', borderColor: '#60a5fa', backgroundColor: 'rgba(96,165,250,0.1)', data: [], tension: 0.4 },
                        { label: 'After Decel', borderColor: '#a78bfa', backgroundColor: 'rgba(167,139,250,0.1)', data: [], tension: 0.4 },
                        { label: 'Actual Velocity (w/ physics)', borderColor: '#4ade80', backgroundColor: 'rgba(74,222,128,0.1)', data: [], tension: 0.4, borderWidth: 2 }
                    ]
                }
            });
            
            decelChart = new Chart(document.getElementById('decelChart'), {
                ...chartConfig,
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Decel Scale', borderColor: '#f472b6', backgroundColor: 'rgba(244,114,182,0.2)', data: [], tension: 0.4, fill: true }
                    ]
                },
                options: {
                    ...chartConfig.options,
                    scales: {
                        x: {
                            title: { display: true, text: 'Distance from Target', color: '#fff' },
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            title: { display: true, text: 'Scale Factor', color: '#fff' },
                            min: 0,
                            max: 1.1,
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }
        
        // PID Controller class (from robot code)
        class PIDController {
            constructor(kP, kI, kD) {
                this.kP = kP;
                this.kI = kI;
                this.kD = kD;
                this.integral = 0;
                this.prevError = 0;
                this.maxIntegral = 50.0;
                this.tolerance = 1.0;
                this.lastP = 0;
                this.lastI = 0;
                this.lastD = 0;
            }
            
            calculate(error, dt) {
                this.lastP = this.kP * error;
                
                this.integral += error * dt;
                if (this.integral > this.maxIntegral) this.integral = this.maxIntegral;
                if (this.integral < -this.maxIntegral) this.integral = -this.maxIntegral;
                this.lastI = this.kI * this.integral;
                
                this.lastD = 0;
                if (dt > 0) {
                    this.lastD = this.kD * (error - this.prevError) / dt;
                }
                
                this.prevError = error;
                return this.lastP + this.lastI + this.lastD;
            }
            
            reset() {
                this.integral = 0;
                this.prevError = 0;
            }
            
            atTarget(error) {
                return Math.abs(error) < this.tolerance;
            }
        }
        
        // Utility function
        function clamp(value, min, max) {
            return Math.max(min, Math.min(max, value));
        }
        
        // Update defaults when switching controller type
        function updateControllerDefaults() {
            const type = document.getElementById('controllerType').value;
            if (type === 'drive') {
                document.getElementById('kP').value = 6.0;
                document.getElementById('kI').value = 0.10;
                document.getElementById('kD').value = 1.0;
                document.getElementById('tolerance').value = 2.0;
                document.getElementById('slowZone').value = 10.0;
                document.getElementById('decelK').value = 0.10;
                document.getElementById('maxDelta').value = 80.0;
                document.getElementById('targetDistance').value = 43;
            } else {
                document.getElementById('kP').value = 0.4;
                document.getElementById('kI').value = 0.01;
                document.getElementById('kD').value = 0.01;
                document.getElementById('tolerance').value = 1.0;
                document.getElementById('slowZone').value = 15.0;
                document.getElementById('decelK').value = 0.10;
                document.getElementById('maxDelta').value = 80.0;
                document.getElementById('targetDistance').value = 90;
            }
        }
        
        // Main simulation function (based on driveWithPID/turnWithPID from robot code)
        function runSimulation() {
            // Get parameters
            const targetDist = parseFloat(document.getElementById('targetDistance').value);
            const maxVel = parseFloat(document.getElementById('maxVelocity').value);
            const kP = parseFloat(document.getElementById('kP').value);
            const kI = parseFloat(document.getElementById('kI').value);
            const kD = parseFloat(document.getElementById('kD').value);
            const tolerance = parseFloat(document.getElementById('tolerance').value);
            const slowZone = parseFloat(document.getElementById('slowZone').value);
            const decelK = parseFloat(document.getElementById('decelK').value);
            const maxDeltaPerSec = parseFloat(document.getElementById('maxDelta').value);
            const minSpeed = parseFloat(document.getElementById('minSpeed').value);
            
            // Initialize PID
            const pid = new PIDController(kP, kI, kD);
            pid.tolerance = tolerance;
            
            // Simulation parameters
            const kLoopDt = 0.01; // 10ms loop time
            const timeout = 5000; // 5 second timeout
            const maxIterations = timeout / (kLoopDt * 1000);
            
            // Robot physical parameters (from actual robot config)
            // 6:1 cartridge = 600 RPM max, realistic ~300 RPM sustained
            // Wheel circumference = 259.34mm = 10.21 inches
            // 300 RPM = 5 rev/sec â†’ 5 * 10.21 = 51 inches/sec at 100%
            const MAX_VELOCITY_IPS = 51.0; // inches per second at 100%
            const MOTOR_RESPONSE_RATE = 25.0; // Higher = motors respond faster to commands
            const FRICTION_COEFF = 1.0; // Carpet/tile friction + drivetrain resistance
            const COAST_DECEL_RATE = 150.0; // Aggressive coast deceleration (VEX motors brake well)
            
            // State variables
            let currentDist = 0;
            let currentSpeed = 0; // commanded speed (%)
            let actualVelocity = 0; // actual velocity with inertia (inches/sec)
            let elapsedTime = 0;
            
            // Data arrays
            const timeData = [];
            const positionData = [];
            const targetData = [];
            const errorData = [];
            const pTermData = [];
            const iTermData = [];
            const dTermData = [];
            const pidOutputData = [];
            const driveSpeedData = [];
            const afterDecelData = [];
            const finalSpeedData = [];
            
            // Statistics
            let peakVel = 0;
            let maxOvershoot = 0;
            let settledTime = -1;
            let iterations = 0;
            
            // Run simulation
            for (let i = 0; i < maxIterations; i++) {
                iterations = i;
                const error = targetDist - currentDist;
                
                // Check if at target
                if (pid.atTarget(error)) {
                    if (settledTime === -1) {
                        settledTime = elapsedTime;
                    }
                    // Continue for a bit to show settling
                    if (i > 10 && elapsedTime - settledTime > 0.2) {
                        break;
                    }
                }
                
                // Calculate PID output
                const pidOutput = pid.calculate(error, kLoopDt);
                let driveSpeed = clamp(pidOutput, -maxVel, maxVel);
                let currentDriveSpeed = driveSpeed;
                
                // Apply exponential deceleration near target (from robot code)
                let decelScale = 1.0;
                if (Math.abs(error) < slowZone) {
                    decelScale = Math.exp(-decelK * (slowZone - Math.abs(error)));
                    decelScale = Math.max(0.90, decelScale);
                    currentDriveSpeed *= decelScale;
                }
                
                // Apply slew rate limiting (smooth acceleration)
                const maxDelta = maxDeltaPerSec * kLoopDt;
                if (currentDriveSpeed - currentSpeed > maxDelta) {
                    currentSpeed += maxDelta;
                } else if (currentSpeed - currentDriveSpeed > maxDelta) {
                    currentSpeed -= maxDelta;
                } else {
                    currentSpeed = currentDriveSpeed;
                }
                
                // Enforce minimum speed
                if (Math.abs(currentSpeed) < minSpeed && Math.abs(error) > 0.5) {
                    currentSpeed = currentSpeed >= 0 ? minSpeed : -minSpeed;
                }
                
                // REALISTIC PHYSICS: Motor output â†’ actual velocity with inertia and friction
                const targetVelocity = (currentSpeed / 100) * MAX_VELOCITY_IPS;
                
                // VEX motors respond quickly - they don't have tons of inertia
                const velocityError = targetVelocity - actualVelocity;
                const motorAcceleration = velocityError * MOTOR_RESPONSE_RATE;
                
                // Friction resists motion (proportional to velocity)
                const frictionDecel = -actualVelocity * FRICTION_COEFF;
                
                // Coast mode: when commanded speed is near zero, brake actively
                let coastDecel = 0;
                if (Math.abs(currentSpeed) < 2.0 && Math.abs(actualVelocity) > 0.5) {
                    coastDecel = -Math.sign(actualVelocity) * COAST_DECEL_RATE * kLoopDt;
                }
                
                // Update velocity
                actualVelocity += motorAcceleration * kLoopDt;
                actualVelocity += frictionDecel * kLoopDt;
                actualVelocity += coastDecel;
                
                // Stop completely at very low speeds
                if (Math.abs(actualVelocity) < 0.5 && Math.abs(currentSpeed) < 2.0) {
                    actualVelocity = 0;
                }
                
                // Update position using actual velocity
                currentDist += actualVelocity * kLoopDt;
                
                // Track overshoot
                if (currentDist > targetDist) {
                    maxOvershoot = Math.max(maxOvershoot, currentDist - targetDist);
                }
                
                // Track peak velocity (convert actual velocity back to %)
                const actualSpeedPercent = (actualVelocity / MAX_VELOCITY_IPS) * 100;
                peakVel = Math.max(peakVel, Math.abs(actualSpeedPercent));
                
                // Record data
                timeData.push(elapsedTime.toFixed(2));
                positionData.push(currentDist.toFixed(2));
                targetData.push(targetDist);
                errorData.push(error.toFixed(2));
                pTermData.push(pid.lastP.toFixed(2));
                iTermData.push(pid.lastI.toFixed(2));
                dTermData.push(pid.lastD.toFixed(2));
                pidOutputData.push(pidOutput.toFixed(2));
                driveSpeedData.push(driveSpeed.toFixed(2));
                afterDecelData.push(currentDriveSpeed.toFixed(2));
                finalSpeedData.push(actualSpeedPercent.toFixed(2));
                
                elapsedTime += kLoopDt;
            }
            
            // Update charts
            positionChart.data.labels = timeData;
            positionChart.data.datasets[0].data = positionData;
            positionChart.data.datasets[1].data = targetData;
            positionChart.data.datasets[2].data = errorData;
            positionChart.update();
            
            pidChart.data.labels = timeData;
            pidChart.data.datasets[0].data = pTermData;
            pidChart.data.datasets[1].data = iTermData;
            pidChart.data.datasets[2].data = dTermData;
            pidChart.data.datasets[3].data = pidOutputData;
            pidChart.update();
            
            velocityChart.data.labels = timeData;
            velocityChart.data.datasets[0].data = driveSpeedData;
            velocityChart.data.datasets[1].data = afterDecelData;
            velocityChart.data.datasets[2].data = finalSpeedData;
            velocityChart.update();
            
            // Generate deceleration profile
            const decelLabels = [];
            const decelData = [];
            for (let dist = slowZone; dist >= 0; dist -= 0.5) {
                decelLabels.push(dist.toFixed(1));
                const scale = Math.max(0.90, Math.exp(-decelK * (slowZone - dist)));
                decelData.push(scale.toFixed(3));
            }
            decelChart.data.labels = decelLabels;
            decelChart.data.datasets[0].data = decelData;
            decelChart.update();
            
            // Update statistics
            document.getElementById('settlingTime').textContent = settledTime >= 0 ? settledTime.toFixed(2) + ' s' : 'Timeout';
            document.getElementById('peakVelocity').textContent = peakVel.toFixed(1) + ' %';
            document.getElementById('overshoot').textContent = maxOvershoot.toFixed(2) + ' in';
            document.getElementById('finalError').textContent = errorData[errorData.length - 1] + ' in';
            document.getElementById('totalIterations').textContent = iterations;
            document.getElementById('success').textContent = settledTime >= 0 ? 'âœ“ Yes' : 'âœ— No';
        }
        
        function resetSimulation() {
            updateControllerDefaults();
            
            // Clear charts
            [positionChart, pidChart, velocityChart, decelChart].forEach(chart => {
                chart.data.labels = [];
                chart.data.datasets.forEach(dataset => dataset.data = []);
                chart.update();
            });
            
            // Clear stats
            document.getElementById('settlingTime').textContent = '--';
            document.getElementById('peakVelocity').textContent = '--';
            document.getElementById('overshoot').textContent = '--';
            document.getElementById('finalError').textContent = '--';
            document.getElementById('totalIterations').textContent = '--';
            document.getElementById('success').textContent = '--';
        }
        
        // Initialize on load
        window.addEventListener('load', () => {
            initCharts();
        });
    </script>
</body>
</html>
